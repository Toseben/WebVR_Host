<html lang="en">
	<head>
		<title>Dynamic Reflection</title>
	</head>
	<body>
		<script src="js/three.js"></script>
		<script src="js/OBJLoader.js"></script>
		<script>
			var camera, scene, renderer;
			var cube, sphere, torus, material;
			var count = 0, cubeCamera, cubeCamera;
			var fov = 60,
			lon = 0, onMouseDownLon = 0,
			lat = 0, onMouseDownLat = 0,
			phi = 0, theta = 0;
			var textureLoader = new THREE.TextureLoader();
			textureLoader.load( 'img/dynamicCubeMap.jpg', function ( texture ) {
				texture.mapping = THREE.UVMapping;
				init( texture );
				animate();
			});

			function init( texture ) {
				camera = new THREE.PerspectiveCamera( fov, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.z = 100;
				scene = new THREE.Scene();
				var mesh = new THREE.Mesh( new THREE.SphereGeometry( 500, 32, 16 ), new THREE.MeshBasicMaterial( { map: texture } ) );
				mesh.scale.x = -1;
				scene.add( mesh );
				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				//
				cubeCamera = new THREE.CubeCamera( 1, 1000, 256 );
				//cubeCamera.renderTarget.texture.minFilter = THREE.LinearMipMapLinearFilter;
				scene.add( cubeCamera );
				material = new THREE.MeshBasicMaterial( { envMap: cubeCamera.renderTarget } );
				sphere = new THREE.Mesh( new THREE.IcosahedronGeometry( 20, 3 ), material );
				scene.add( sphere );
				document.body.appendChild( renderer.domElement );
				//
				torus = new THREE.Mesh( new THREE.TorusKnotGeometry( 10, 5, 100, 25 ), material );
				torus.position.set( 30, 0, 30 );
				scene.add( torus );
			}
			function animate() {
				requestAnimationFrame( animate );
				render();
			}
			function render() {
				sphere.visible = false;
				cubeCamera.updateCubeMap( renderer, scene );
				sphere.visible = true;
				material.envMap = cubeCamera.renderTarget.texture;
				renderer.render( scene, camera );
			}
		</script>
	</body>
</html>